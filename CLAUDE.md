# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Personal blog at https://blog.iamjkahn.com — built with Astro 5, React, Tailwind CSS v4, and deployed to Cloudflare Workers.

## Research

When creating a new feature, conduct research based on the prompt provided. Initial findings and research should be documented in a feature specific folder in `_planning_`. User will review research and provide feedback before you generate a plan document, also in the same directory. The plan doc will contain tasks. Prompt for user to review and provide feedback before starting implementation.

## Commands

- `pnpm dev` — Start dev server
- `pnpm build` — Runs `wrangler types && astro build` (regenerates `worker-configuration.d.ts` first)
- `pnpm preview` — Preview production build locally (uses Wrangler)
- `pnpm lint` — Run ESLint
- `pnpm create` — Interactive CLI to scaffold a new blog post (prompts for title, slug, date, local vs link post)
- `npx prettier --write <file>` — Format a file (uses prettier-plugin-astro and prettier-plugin-tailwindcss)

## Architecture

**Rendering**: Hybrid SSR/static. The site is configured with `output: 'server'` and the Cloudflare adapter, but most pages opt into static prerendering via `export const prerender = true`. The `Bluesky.astro` component is the primary dynamic/SSR component.

**Content**: Blog posts are Markdown files in `src/content/blog/` using Astro's content collections with a glob loader. Filenames follow `YYYY-MM-DD-slug.md`. The schema is defined in `src/content.config.ts` — posts have `title`, `date`, `author`, `summary`, and an optional `redirect_link` for link-style posts that point to external URLs. Legacy Blogger fields (`tags`, `blogger_id`, etc.) are kept optional and ignored in templates.

**Slug derivation**: The day component is stripped when building URLs. `2024-12-12-my-post.md` → `id = "2024-12-12-my-post"` → URL `/posts/2024/12/my-post`. This pattern appears in the post route, RSS feed, and index page.

**Routing**: Post pages use dynamic routes at `src/pages/posts/[year]/[month]/[slug].astro`. A middleware (`src/middleware.ts`) handles legacy Blogger URL redirects (`/YYYY/MM/slug.html` → `/posts/YYYY/MM/slug`). The `/archive` → `/posts` redirect is in `astro.config.ts`.

**Path alias**: `@/` resolves to `src/` — use it for all internal imports.

**Layouts**: `src/layouts/Base.astro` is the base HTML layout. `src/components/Layout.astro` wraps pages with header/footer. `src/components/PostLayout.astro` is the blog post layout. `src/components/SimpleLayout.astro` is for simple pages (about, speaking).

**Components**: Mix of `.astro` and `.jsx` (React) components. React is used for interactive components. The Card component is split into subcomponents in `src/components/Card/` (`Card.astro`, `CardTitle.astro`, `CardDescription.astro`, `CardEyebrow.astro`, `CardCta.astro`, `Link.astro`). The Widget component lives in `src/components/Widget/`.

**Bluesky widget**: `src/components/Bluesky.astro` fetches the latest post via AT Protocol (`src/lib/bluesky.ts`). It uses `server:defer` for deferred loading and `cdn-cache-control` for cache headers. Requires `BLUESKY_HANDLE` and `BLUESKY_APP_PASSWORD` environment variables (set in Cloudflare Workers secrets for production).

**Styling**: Tailwind CSS v4 via Vite plugin (not PostCSS). Global styles in `src/css/tailwind.css`. Typography uses `@tailwindcss/typography`.

**Formatting**: Prettier with no semicolons, double quotes. Import sorting via `@trivago/prettier-plugin-sort-imports`. Config in `prettier.config.js`.

**Generated files**: `worker-configuration.d.ts` is auto-generated by `wrangler types` — do not edit manually.
