---
import { BlueskyPost, type Post } from "@astro-community/astro-embed-bluesky";
import { CacheHeaders } from "cdn-cache-control";
import { getAgent } from "../lib/bluesky";

export const prerender = false;

const { actor, cacheTime = 3600 } = Astro.props;

let post: Post | undefined;

try {
  const { BLUESKY_HANDLE, BLUESKY_APP_PASSWORD } = Astro.locals.runtime.env;
  const agent = await getAgent(BLUESKY_HANDLE, BLUESKY_APP_PASSWORD);
  const { data } = await agent.getAuthorFeed({ actor, limit: 1 });
  post = data.feed[0]?.post as Post | undefined;
} catch (err) {
  console.error("[ðŸ¦‹ Bluesky component]", err);
}

if (post) {
  const headers = new CacheHeaders()
    .swr()
    .ttl(cacheTime)
    .tag(["posts", `post-${actor}`]);
  headers.forEach((value, key) => Astro.response.headers.set(key, value));
}
---

{post && <BlueskyPost post={post} />}
